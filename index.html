<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Keuangan Mobile</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <style>
        /* RESET & BASE */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
            touch-action: manipulation;
        }

        .app-container {
            max-width: 100%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 95vh;
        }

        /* HEADER */
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 15px;
            text-align: center;
        }

        .app-title {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .app-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }

        /* NAVIGASI TABS */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1px;
            background: #e0e0e0;
            padding: 1px;
            position: relative;
            z-index: 10;
        }

        .nav-btn {
            background: white;
            border: none;
            padding: 12px 5px;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 4px;
        }

        .nav-btn.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            font-weight: 700;
        }

        /* SCREENS */
        .screen {
            display: none;
            padding: 15px;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* FORM */
        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 6px;
            color: #555;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 15px;
            background: #f8f9fa;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        /* BUTTON */
        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-top: 10px;
        }

        /* SUMMARY CARD */
        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            text-align: center;
        }

        .summary-amount {
            font-size: 24px;
            font-weight: 700;
        }

        /* TABLE CUSTOMIZATION */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid #ddd;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: #f5f5f5;
            padding: 8px;
            font-size: 11px;
            text-align: left;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid #eee;
            font-size: 12px;
            vertical-align: top;
        }

        .date-stack {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .date-label {
            font-size: 9px;
            color: #888;
            text-transform: uppercase;
        }

        /* RIWAYAT BAYAR */
        .payment-history {
            margin-top: 5px;
            padding: 6px;
            background: #f0f2f5;
            border-radius: 4px;
        }

        .action-btn {
            padding: 8px;
            border: none;
            border-radius: 5px;
            font-size: 11px;
            font-weight: 600;
            width: 100%;
            margin-bottom: 5px;
        }

        .action-btn.pay { background: #28a745; color: white; }
        .action-btn.delete { background: #dc3545; color: white; }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="app-header">
            <div class="app-title">üí∞ Keuangan Mobile</div>
            <div class="app-subtitle">Kelola hutang & piutang</div>
        </div>

        <div class="nav-tabs" id="navTabs">
            <button class="nav-btn active" data-target="transaksi"><span>‚ûï Tambah</span></button>
            <button class="nav-btn" data-target="hutang"><span>üìâ Hutang</span></button>
            <button class="nav-btn" data-target="piutang"><span>üìà Piutang</span></button>
            <button class="nav-btn" data-target="backup"><span>üíæ Backup</span></button>
        </div>

        <div id="transaksi" class="screen active">
            <form id="financeForm">
                <div class="form-group">
                    <label class="form-label">Jenis Transaksi</label>
                    <select id="jenis" class="form-select">
                        <option value="hutang">üè¶ Hutang</option>
                        <option value="piutang">üë§ Piutang</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tanggal</label>
                        <input type="date" id="tanggal" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Jatuh Tempo</label>
                        <input type="date" id="jatuh_tempo" class="form-input">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Jumlah (Rp)</label>
                    <input type="number" id="jumlah" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Keterangan</label>
                    <textarea id="keterangan" class="form-textarea" rows="2"></textarea>
                </div>
                <button type="submit" class="btn">üíæ Simpan Transaksi</button>
            </form>
        </div>

        <div id="hutang" class="screen">
            <div class="summary-card">
                <div>Total Hutang</div>
                <div class="summary-amount">Rp <span id="totalHutang">0</span></div>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Waktu (Tgl/Tempo)</th>
                            <th>Ket & Riwayat</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="hutangTable"></tbody>
                </table>
            </div>
        </div>

        <div id="piutang" class="screen">
            <div class="summary-card">
                <div>Total Piutang</div>
                <div class="summary-amount">Rp <span id="totalPiutang">0</span></div>
            </div>
            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Waktu (Tgl/Tempo)</th>
                            <th>Ket & Riwayat</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="piutangTable"></tbody>
                </table>
            </div>
        </div>

        <div id="backup" class="screen">
            <button onclick="exportData()" class="btn">üì• Download Backup</button>
            <div class="form-group" style="margin-top: 20px;">
                <label class="form-label">Restore (Paste JSON)</label>
                <textarea id="importData" class="form-textarea" rows="4"></textarea>
                <button onclick="importData()" class="btn" style="background: #6c757d;">üîÑ Restore Data</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
            setupNavigation();
            setupForm();
            loadData();
        });

        function setupNavigation() {
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    const target = document.getElementById(this.dataset.target);
                    target.classList.add('active');
                    if(this.dataset.target !== 'transaksi') loadData();
                });
            });
        }

        function setupForm() {
            document.getElementById('financeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                const data = {
                    id: Date.now(),
                    jenis: document.getElementById('jenis').value,
                    tanggal: document.getElementById('tanggal').value,
                    jatuh_tempo: document.getElementById('jatuh_tempo').value || '-',
                    jumlah: parseFloat(document.getElementById('jumlah').value),
                    bayar: 0,
                    riwayat: [],
                    keterangan: document.getElementById('keterangan').value || '-'
                };
                const storage = JSON.parse(localStorage.getItem('keuangan_data')) || [];
                storage.push(data);
                localStorage.setItem('keuangan_data', JSON.stringify(storage));
                this.reset();
                showToast('‚úÖ Berhasil disimpan');
                document.querySelector(`[data-target="${data.jenis}"]`).click();
            });
        }

        function loadData() {
            const data = JSON.parse(localStorage.getItem('keuangan_data')) || [];
            renderTable('hutang', data.filter(d => d.jenis === 'hutang'));
            renderTable('piutang', data.filter(d => d.jenis === 'piutang'));
        }

        function renderTable(type, items) {
            const table = document.getElementById(`${type}Table`);
            const totalDisplay = document.getElementById(`total${type.charAt(0).toUpperCase() + type.slice(1)}`);
            let totalSisa = 0;
            table.innerHTML = '';

            items.forEach(item => {
                const sisa = item.jumlah - item.bayar;
                totalSisa += sisa;
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>
                        <div class="date-stack">
                            <div><span class="date-label">Tgl:</span> ${formatDate(item.tanggal)}</div>
                            <div style="color: ${isOverdue(item.jatuh_tempo) ? 'red' : '#666'}">
                                <span class="date-label">Jatuh Tempo:</span><br>${formatDate(item.jatuh_tempo)}
                            </div>
                        </div>
                    </td>
                    <td>
                        <strong>${item.keterangan}</strong><br>
                        <span style="color:#667eea">Total: ${formatCurrency(item.jumlah)}</span><br>
                        <span style="font-weight:bold">Sisa: ${formatCurrency(sisa)}</span>
                        ${renderRiwayat(item.riwayat)}
                    </td>
                    <td style="width: 80px">
                        ${sisa > 0 ? `<button class="action-btn pay" onclick="addPayment(${item.id})">${type === 'hutang' ? 'Bayar' : 'Terima'}</button>` : '<span style="color:green">LUNAS</span>'}
                        <button class="action-btn delete" onclick="deleteItem(${item.id})">Hapus</button>
                    </td>
                `;
                table.appendChild(row);
            });
            totalDisplay.textContent = formatCurrency(totalSisa);
        }

        function renderRiwayat(riwayat) {
            if(!riwayat || riwayat.length === 0) return '';
            return `<div class="payment-history">` + 
                riwayat.map(r => `<div style="font-size:10px; border-bottom:1px dashed #ccc; margin-bottom:2px">
                    ${formatDate(r.tgl)} - ${r.metode}: <b>${formatCurrency(r.nominal)}</b>
                </div>`).join('') + `</div>`;
        }

        async function addPayment(id) {
            const storage = JSON.parse(localStorage.getItem('keuangan_data'));
            const idx = storage.findIndex(i => i.id === id);
            const item = storage[idx];
            const sisa = item.jumlah - item.bayar;

            const nominal = prompt(`Masukkan Nominal (Sisa: ${sisa})`, sisa);
            if(!nominal || isNaN(nominal) || nominal <= 0) return;

            // Fitur Baru: Kalender & Metode
            const tglBayar = prompt("Tanggal Bayar (YYYY-MM-DD)", new Date().toISOString().split('T')[0]);
            if(!tglBayar) return;

            const metode = prompt("Metode (Tunai/Transfer/Lainnya)", "Tunai");
            
            item.bayar += parseFloat(nominal);
            item.riwayat.push({
                tgl: tglBayar,
                nominal: parseFloat(nominal),
                metode: metode
            });

            localStorage.setItem('keuangan_data', JSON.stringify(storage));
            loadData();
            showToast('‚úÖ Pembayaran dicatat');
        }

        function deleteItem(id) {
            if(confirm('Hapus data ini?')) {
                let storage = JSON.parse(localStorage.getItem('keuangan_data'));
                storage = storage.filter(i => i.id !== id);
                localStorage.setItem('keuangan_data', JSON.stringify(storage));
                loadData();
            }
        }

        function formatDate(s) {
            if(!s || s === '-') return '-';
            const d = new Date(s);
            return d.toLocaleDateString('id-ID', { day:'2-digit', month:'2-digit', year:'numeric' });
        }

        function isOverdue(s) {
            if(!s || s === '-') return false;
            return new Date(s) < new Date().setHours(0,0,0,0);
        }

        function formatCurrency(n) {
            return new Intl.NumberFormat('id-ID').format(n);
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.textContent = msg;
            t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 2000);
        }

        function exportData() {
            const data = localStorage
