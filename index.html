<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Keuangan Mobile</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#764ba2">
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 10px;
            color: #333;
        }
        .app-container {
            max-width: 100%;
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            min-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .app-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 15px; text-align: center; }
        
        /* NAVIGASI FIX */
        .nav-tabs {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
        }
        .nav-btn {
            background: none;
            border: none;
            padding: 15px 5px;
            font-size: 11px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            transition: 0.3s;
        }
        .nav-btn.active {
            color: #667eea;
            border-bottom: 3px solid #667eea;
            background: #fff;
        }

        .screen { display: none; padding: 15px; flex-grow: 1; }
        .screen.active { display: block; }

        /* FORM STYLES */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; margin-bottom: 6px; }
        .form-input, .form-select, .form-textarea {
            width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 15px;
        }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn {
            width: 100%; padding: 15px; border: none; border-radius: 8px; font-size: 15px;
            font-weight: 700; cursor: pointer; background: #667eea; color: white;
        }

        /* TABLE STYLES */
        .summary-card { background: #764ba2; color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: center; }
        .summary-amount { font-size: 20px; font-weight: 700; }
        .table-container { overflow-x: auto; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .data-table th { background: #eee; padding: 10px; font-size: 11px; text-align: left; }
        .data-table td { padding: 10px; border-bottom: 1px solid #eee; font-size: 12px; vertical-align: top; }
        
        /* Tanggal Atas Bawah */
        .date-box { display: flex; flex-direction: column; line-height: 1.4; }
        .date-label { font-size: 9px; color: #888; text-transform: uppercase; font-weight: bold; }
        
        .payment-history { margin-top: 8px; padding: 5px; background: #f0f0f0; border-radius: 4px; font-size: 10px; }
        .action-btn { padding: 6px; border-radius: 4px; border: none; font-size: 10px; font-weight: bold; width: 100%; margin-bottom: 4px; color: white; }
        .btn-pay { background: #28a745; }
        .btn-del { background: #dc3545; }
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 20px; display: none; z-index: 100; }
    </style>
</head>
<body>

<div class="app-container">
    <div class="app-header">
        <h2>Keuangan Mobile</h2>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn active" onclick="openScreen('transaksi', this)">âž• Input</button>
        <button class="nav-btn" onclick="openScreen('hutang', this)">ðŸ“‰ Hutang</button>
        <button class="nav-btn" onclick="openScreen('piutang', this)">ðŸ“ˆ Piutang</button>
        <button class="nav-btn" onclick="openScreen('backup', this)">ðŸ’¾ Backup</button>
    </div>

    <div id="transaksi" class="screen active">
        <form id="financeForm">
            <div class="form-group">
                <label class="form-label">Jenis</label>
                <select id="jenis" class="form-select">
                    <option value="hutang">Hutang (Pinjam)</option>
                    <option value="piutang">Piutang (Dipinjam)</option>
                </select>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tgl Pinjam</label>
                    <input type="date" id="tanggal" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Jatuh Tempo</label>
                    <input type="date" id="jatuh_tempo" class="form-input">
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Nominal (Rp)</label>
                <input type="number" id="jumlah" class="form-input" placeholder="0" required>
            </div>
            <div class="form-group">
                <label class="form-label">Keterangan</label>
                <textarea id="keterangan" class="form-textarea" rows="2" placeholder="Nama orang / keperluan"></textarea>
            </div>
            <button type="submit" class="btn">SIMPAN DATA</button>
        </form>
    </div>

    <div id="hutang" class="screen">
        <div class="summary-card">
            <p>Total Hutang Anda</p>
            <div class="summary-amount" id="totalHutang">Rp 0</div>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tgl / Tempo</th>
                        <th>Ket / Sisa</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="listHutang"></tbody>
            </table>
        </div>
    </div>

    <div id="piutang" class="screen">
        <div class="summary-card" style="background: #28a745;">
            <p>Total Piutang Anda</p>
            <div class="summary-amount" id="totalPiutang">Rp 0</div>
        </div>
        <div class="table-container">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tgl / Tempo</th>
                        <th>Ket / Sisa</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="listPiutang"></tbody>
            </table>
        </div>
    </div>

    <div id="backup" class="screen">
        <button class="btn" onclick="exportData()" style="background: #6c757d;">ðŸ“¥ Download Backup (.json)</button>
        <p style="margin-top:20px; font-size: 12px; font-weight: bold;">Restore Data:</p>
        <input type="file" id="fileInput" class="form-input" accept=".json" onchange="importData(event)">
    </div>
</div>

<div id="toast" class="toast"></div>

<script>
    // Inisialisasi awal
    document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];

    // Fungsi Navigasi (Global agar selalu bisa diakses)
    function openScreen(screenId, btn) {
        // Sembunyikan semua screen
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        // Nonaktifkan semua button
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        
        // Aktifkan yang dipilih
        document.getElementById(screenId).classList.add('active');
        btn.classList.add('active');

        if(screenId === 'hutang' || screenId === 'piutang') {
            renderData();
        }
    }

    // Handle Simpan
    document.getElementById('financeForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newData = {
            id: Date.now(),
            jenis: document.getElementById('jenis').value,
            tanggal: document.getElementById('tanggal').value,
            jatuh_tempo: document.getElementById('jatuh_tempo').value || '-',
            jumlah: parseFloat(document.getElementById('jumlah').value),
            terbayar: 0,
            riwayat: [],
            keterangan: document.getElementById('keterangan').value || 'Tanpa keterangan'
        };

        const storage = JSON.parse(localStorage.getItem('my_finance_v1')) || [];
        storage.push(newData);
        localStorage.setItem('my_finance_v1', JSON.stringify(storage));

        this.reset();
        document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
        
        showToast("âœ… Berhasil Disimpan");
        
        // Pindah ke halaman list otomatis
        const targetBtn = document.querySelector(`.nav-btn[onclick*="${newData.jenis}"]`);
        openScreen(newData.jenis, targetBtn);
    });

    function renderData() {
        const storage = JSON.parse(localStorage.getItem('my_finance_v1')) || [];
        const listHutang = document.getElementById('listHutang');
        const listPiutang = document.getElementById('listPiutang');
        
        listHutang.innerHTML = '';
        listPiutang.innerHTML = '';
        
        let sumHutang = 0;
        let sumPiutang = 0;

        storage.forEach(item => {
            const sisa = item.jumlah - item.terbayar;
            const row = `
                <tr>
                    <td>
                        <div class="date-box">
                            <span class="date-label">PINJAM</span>
                            <span>${formatTgl(item.tanggal)}</span>
                            <span class="date-label" style="margin-top:5px">TEMPO</span>
                            <span style="color:${isOverdue(item.jatuh_tempo) ? 'red' : 'inherit'}">${formatTgl(item.jatuh_tempo)}</span>
                        </div>
                    </td>
                    <td>
                        <strong>${item.keterangan}</strong><br>
                        Sisa: <b>${formatRp(sisa)}</b>
                        <div class="payment-history">
                            ${item.riwayat.map(r => `â€¢ ${formatTgl(r.tgl)}: ${formatRp(r.nom)} (${r.met})`).join('<br>')}
                        </div>
                    </td>
                    <td>
                        ${sisa > 0 ? `<button class="action-btn btn-pay" onclick="payItem(${item.id})">BAYAR</button>` : 'âœ…'}
                        <button class="action-btn btn-del" onclick="deleteItem(${item.id})">HAPUS</button>
                    </td>
                </tr>
            `;

            if(item.jenis === 'hutang') {
                listHutang.innerHTML += row;
                sumHutang += sisa;
            } else {
                listPiutang.innerHTML += row;
                sumPiutang += sisa;
            }
        });

        document.getElementById('totalHutang').textContent = formatRp(sumHutang);
        document.getElementById('totalPiutang').textContent = formatRp(sumPiutang);
    }

    function payItem(id) {
        const storage = JSON.parse(localStorage.getItem('my_finance_v1'));
        const idx = storage.findIndex(i => i.id === id);
        const sisa = storage[idx].jumlah - storage[idx].terbayar;

        const nominal = prompt("Masukkan Nominal Bayar:", sisa);
        if(!nominal || nominal <= 0) return;

        const tglBayar = prompt("Tanggal Bayar (YYYY-MM-DD):", new Date().toISOString().split('T')[0]);
        const metode = prompt("Metode (Tunai/Transfer):", "Tunai");

        storage[idx].terbayar += parseFloat(nominal);
        storage[idx].riwayat.push({
            tgl: tglBayar,
            nom: parseFloat(nominal),
            met: metode
        });

        localStorage.setItem('my_finance_v1', JSON.stringify(storage));
        renderData();
        showToast("ðŸ’° Pembayaran Dicatat");
    }

    function deleteItem(id) {
        if(confirm("Hapus data ini?")) {
            let storage = JSON.parse(localStorage.getItem('my_finance_v1'));
            storage = storage.filter(i => i.id !== id);
            localStorage.setItem('my_finance_v1', JSON.stringify(storage));
            renderData();
        }
    }

    // Utils
    function formatRp(v) { return "Rp " + new Intl.NumberFormat('id-ID').format(v); }
    function formatTgl(s) { 
        if(!s || s === '-') return '-';
        const d = s.split('-'); 
        return d.length === 3 ? `${d[2]}/${d[1]}/${d[0]}` : s; 
    }
    function isOverdue(s) {
        if(!s || s === '-') return false;
        return new Date(s) < new Date().setHours(0,0,0,0);
    }
    function showToast(m) {
        const t = document.getElementById('toast');
        t.textContent = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 2000);
    }

    // Backup & Restore
    function exportData() {
        const data = localStorage.getItem('my_finance_v1') || '[]';
        const blob = new Blob([data], {type: 'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `backup_keuangan_${new Date().getTime()}.json`;
        a.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                localStorage.setItem('my_finance_v1', JSON.stringify(json));
                alert("Restore Berhasil!");
                location.reload();
            } catch(err) { alert("File tidak valid!"); }
        };
        reader.readAsText(file);
    }
</script>

</body>
</html>
